---
title: "SI3. Linear Mixed-Effects Model"
author:
    - Chiara Santolin*
    - Gonzalo Garc√≠a-Castro
    - Martin Zettersten
    - Nuria Sebastian-Galles
    - Jenny R. Saffran
date: "Updated: `r format(Sys.Date(), '%B %dth, %Y')`"
output:
  pdf_document:
    fig_caption: yes
  word_document:
    reference_docx: flip_template.docx
bibliography: "../Flip.bib"
csl: "../apa.csl"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo    = TRUE,
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	out.width = "100%"
)
options(knitr.kable.NA = '-', big.mark = ',') # to replace "NA" with "-" in knitr::kable

```

```{r prepare, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# load packages
library(tidyverse)    # tidyverse packages
library(magrittr)     # for using pipes
library(knitr)        # for formatting tables
library(english)      # for transforming numbers to words
library(here)         # for locating files

# import data from Item-dummy-coded model (baseline on familiar trials)
data      <- read.csv(here("Data", "01_data-processed.csv"), header = TRUE)
anova     <- read.csv(here("Data", "02_results-lmem.csv"), header = TRUE, sep = ",")
effects   <- read.table(here("Data", "02_results-effects.csv"), header = TRUE, sep = ",")
fitted    <- read.table(here("Data", "02_results-fitted.csv"), header = TRUE, sep = ",")
# import HPP4 data
anova4     <- read.csv(here("Data", "HPP3", "02_results-lmem-3.csv"), header = TRUE, sep = ",")
# import data from Item-effect-coded and Item-dummy-coded (baseline on novel trials) models 
anova.effect <- read.csv(here("Data", "Effect-coding", "02_results-lmem-effect.csv"), header = TRUE, sep = ",")
anova.novel  <- read.csv(here("Data", "Dummy-coding-Novel", "02_results-lmem-novel.csv"), header = TRUE, sep = ",")
```

We fit a Linear Mixed-Effects Model (LMEM) with looking time ($LT$) as response variable, that included test item ($Item$, Familiar vs. Novel),  number of HeadTurn Preference Procedure experiments completed by infants ($HPP$), and their interaction ($Item \times HPP$), as fixed effects. The $Item$ predictor was dummt-coded, with *Familiar* trials as the baseline. Participant ($Participant$) and study ($Study$) were included as random effects. Following @barr2013, we fit a model with that included all random effects our design could allow. Initially, this maximal model included by-participant, by-study random intercepts, by-study $HPP$ and $Item$ random slopes, and all variance components of the variance-covariance matrix for the by-study random effects. By-participant $HPP$ random slopes were not included, as the sample was cross-sectional. We specifiyied by-study random effects for two strong reasons. First, participants from different linguistic/cultural environments were included in both studies. This may have led to participants in one of the locations to looking longer in average than those from the other location. Second, in spite of their similarity both studies were not identical, which could also have led to differences in overall looking time. 

We used the `lmer` function of the `lme4` package [@bates2015] of the R environment [@rcoreteam2018] to fit the model. We simplified the random effects structure of the model until we obtained plausible values of the variance components of the variance-covariance matrix (i.e., correlation parameter was not near-boundary and variance components were not zero). The resulting model only included by-participant and by-study random intercepts. Its correspondent formula for being fitted in `lme4` was the following: 

`LookingTime ~ Item * HPP + (1 | Participant) + (1 | Study)`

This model accounts for cross-participants variability in overall looking time (i.e., some infants are long lookers, some are short lookers), and for cross-studies differences in overall looking time (i.e., infants from some studies may look longer overall than infants from other studies). This model converged successfully. 

Significance testing was conducted by performing an *F*-test with Kenward-Roger approximation to degrees of freedom [@kenward2009] on the coefficients of the fixed effects. We used the `Anova` function of the `car` R package [@fox2019] to do so. We found a statistically significant interaction, *F*(`r round(anova$Df[4], 2)`, `r round(anova$Df.res[4], 2)`) = `r round(anova$F[4], 2)`, *p* = `r format(round(anova$p[4], 4), scientific=FALSE)`, 95% CI = [`r anova$CI95[4]`], suggesting that the effect of trial type on looking time was influenced by the number of HPP experiments each participant participated in. The interaction shows that experience with a higher number of HPP experiments is associated with a stronger novelty preference.

```{r anova, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

anova %>%
  mutate(term = c("Intercept", "Item", "HPP", "Item * HPP"),
         p = anova$p) %>%
  select(term, Coefficient, SEM, CI95, F, Df.res, p) %>%
  
  kable(digits = 4, col.names = c("Term", "Coefficient", "SEM", "95%CI", "F", "Den. df", "p"), align = "c",
        caption = "Estimates of the linear mixed-effects model and outcomes of the Kenward-Roger F-tests performed on fixed effects. 95% confidence intervals were bootstrapped.") 

```


```{r coefficients, echo=FALSE, fig.align="c", message=FALSE, warning=FALSE, fig.cap="Coefficients of the model. Black dots and error bars indicate the coefficient and SEM estimated by the model. Grey boxes indicate the 95% confidence interval."}

include_graphics(here("Figures", "03_coefficients.png"))
```


```{r interaction, echo=FALSE, fig.align="c", fig.cap="Predicted looking times plotted against HPP.", message=FALSE, warning=FALSE}

include_graphics(here("Figures", "03_interaction.png"))

```


## Comparison between models with different coding for $Item$

### Model with Item dummy-coded with baseline on **familiar** trials (reported above)

```{r coding_dummy_familiar, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
anova %>%
  mutate(term = c("Intercept", "Item", "HPP", "Item*HPP"),
         p = anova$p) %>%
  select(term, Coefficient, SEM, CI95, F, Df.res, p) %>%
  kable(digits = 4, col.names = c("Term", "Coefficient", "SEM", "95%CI", "F", "Den. df", "p"), align = "c",
        caption = "Estimates of the Item-dummy-coded linear mixed-effects model (with familiar trials as baseline) and outcomes of the Kenward-Roger F-tests performed on fixed effects. 95% confidence intervals were bootstrapped. This model is identical to the one reported above.")
```

### Model with Item dummy-coded with baseline on **novel** trials

```{r coding_dummy_novel, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
anova.novel %>%
  mutate(term = c("Intercept", "ItemNovel", "HPP", "ItemNovel*HPP"),
         p = anova.novel$p) %>%
  select(term, Coefficient, SEM, CI95, F, Df.res, p) %>%
  kable(digits = 4, col.names = c("Term", "Coefficient", "SEM", "95%CI", "F", "Den. df", "p"), align = "c",
        caption = "Estimates of the Item-dummy-coded linear mixed-effects model (with novel trials as baseline) and outcomes of the Kenward-Roger F-tests performed on fixed effects. 95% confidence intervals were bootstrapped.")
```

### Model with Item **effect**-coded

```{r coding_effect, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
anova.effect %>%
  mutate(term = c("Intercept", "ItemCenter", "HPP", "ItemCenter*HPP"),
         p = anova.effect$p) %>%
  select(term, Coefficient, SEM, CI95, F, Df.res, p) %>%
  kable(digits = 4, col.names = c("Term", "Coefficient", "SEM", "95%CI", "F", "Den. df", "p"), align = "c",
        caption = "Estimates of the Item-effect-coded linear mixed-effects model and outcomes of the Kenward-Roger F-tests performed on fixed effects. 95% confidence intervals were bootstrapped.")
```

## HPP4

Given the reduced number of infants that had participated in the studies more than 4 times, we tested the robustness of the estimated coefficients by fitting a model that only included participants with experience in 1 up to 4 HPP studies. This model showed similar outcomes. We found a statistically significant interaction, *F*(`r round(anova4$Df[4], 2)`, `r round(anova4$Df.res[4], 2)`) = `r round(anova4$F[4], 2)`, *p* = `r format(round(anova4$p[4], 4), scientific=FALSE)`, 95% CI = [`r anova4$CI95[4]`], suggesting that the effect of trial type on looking time was influenced by the number of HPP experiments each participant participated in. The interaction shows that experience with a higher number of HPP experiments is associated with a stronger novelty preference. The main effect of HPP, however, was no longer statistically significant.

```{r HPP4, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
anova4 %>% 
  mutate(term = c("Intercept", "Item", "HPP", "Item * HPP"),
         p = anova.novel$p) %>%
  select(term, Coefficient, SEM, CI95, F, Df.res, p) %>%
  kable(digits = 4, col.names = c("Term", "Coefficient", "SEM", "95%CI", "F", "Den. df", "p"), align = "c",
        caption = "Estimates of the Item-dummy-coded linear mixed-effects model (with familiar trials as baseline) and outcomes of the Kenward-Roger F-tests performed on fixed effects. Participants with more than 3 HPP studies have been excluded. 95% confidence intervals were bootstrapped.")

```

## References

\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent